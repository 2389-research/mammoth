{{/* ABOUTME: Diagram tab that renders the spec's DOT graph visually using viz.js. */}}
{{/* ABOUTME: Fetches DOT source from the server and renders it as an SVG in the browser. */}}

<div class="diagram-panel">
    <div class="diagram-toolbar">
        <button class="btn btn-sm btn-regen"
                hx-get="/web/specs/{{ .SpecID }}/diagram"
                hx-target="#canvas" hx-swap="innerHTML"
                title="Regenerate diagram from current spec data">
            Regenerate
        </button>
        <button class="btn btn-sm btn-copy" id="diagram-copy-dot" title="Copy DOT source">Copy DOT</button>
        <a href="/web/specs/{{ .SpecID }}/export/dot" download="spec.dot" class="btn btn-sm btn-download">Download DOT</a>
        <button class="btn btn-sm btn-export"
                hx-post="/web/specs/{{ .SpecID }}/regenerate"
                hx-target=".regen-status" hx-swap="innerHTML"
                title="Save exports to disk">
            Export to Disk
        </button>
        <span class="regen-status"></span>
    </div>
    <div class="diagram-container" id="diagram-render">
        {{ if not .DOTContent }}
        <div class="diagram-empty">
            <p>No diagram data yet. Agents will generate a DOT graph as the spec develops.</p>
        </div>
        {{ end }}
    </div>
    {{ if .Steps }}
    <section class="diagram-steps">
        <h3>Execution Steps</h3>
        <div class="diagram-step-list">
            {{ range .Steps }}
            <article class="diagram-step">
                <header class="diagram-step-head">
                    <span class="diagram-step-index">Step {{ .Index }}</span>
                    <span class="diagram-step-title">{{ .Label }}</span>
                    <code class="diagram-step-id">{{ .NodeID }}</code>
                    {{ if .NodeType }}<span class="diagram-step-type">{{ .NodeType }}</span>{{ end }}
                </header>
                <div class="diagram-step-body">
                    <div class="diagram-step-prompt-label">Prompt</div>
                    {{ if .Prompt }}
                    <pre class="diagram-step-prompt"><code>{{ .Prompt }}</code></pre>
                    {{ else }}
                    <p class="diagram-step-empty">No explicit prompt on this node.</p>
                    {{ end }}
                    {{ if .Outgoing }}
                    <div class="diagram-step-next">
                        <span>Next:</span>
                        {{ range .Outgoing }}
                        <span class="diagram-step-edge">
                            {{ .To }}{{ if .Label }} <em>({{ .Label }})</em>{{ end }}
                        </span>
                        {{ end }}
                    </div>
                    {{ end }}
                </div>
            </article>
            {{ end }}
        </div>
    </section>
    {{ end }}
</div>

<script>
    (function() {
        var dot = {{ .DOTContent | json }};
        if (!dot || dot.trim() === '') return;

        var container = document.getElementById('diagram-render');
        if (!container) return;

        if (typeof Viz === 'undefined') {
            container.innerHTML = '<p class="error-msg">Viz.js not loaded. Cannot render diagram.</p>';
            return;
        }

        Viz.instance().then(function(viz) {
            try {
                var svg = viz.renderSVGElement(dot);
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxHeight = '70vh';
                container.innerHTML = '';
                container.appendChild(svg);
            } catch (e) {
                container.innerHTML = '';
                var errP = document.createElement('p');
                errP.className = 'error-msg';
                errP.textContent = 'Failed to render diagram: ' + e.message;
                container.appendChild(errP);
                var pre = document.createElement('pre');
                pre.className = 'artifact-source';
                var code = document.createElement('code');
                code.textContent = dot;
                pre.appendChild(code);
                container.appendChild(pre);
            }
        });

        // Copy DOT source
        var copyBtn = document.getElementById('diagram-copy-dot');
        if (copyBtn) {
            copyBtn.addEventListener('click', function() {
                navigator.clipboard.writeText(dot).then(function() {
                    copyBtn.textContent = 'Copied!';
                    setTimeout(function() { copyBtn.textContent = 'Copy DOT'; }, 2000);
                });
            });
        }
    })();
</script>
