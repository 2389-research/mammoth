{{/* ABOUTME: Activity transcript with message feed and pending question widget. */}}
{{/* ABOUTME: Parameterized by ContainerID so both activity panel and chat tab can share it. */}}
{{ define "activity_transcript" }}
<div id="{{ .ContainerID }}"
     hx-trigger="sse:transcript_appended, sse:question_asked, sse:question_answered, sse:agent_step_started, sse:agent_step_finished"
     hx-get="/web/specs/{{ .SpecID }}/activity/transcript?container_id={{ .ContainerID }}"
     hx-target="#{{ .ContainerID }}"
     hx-swap="outerHTML">
    <div class="activity-feed" id="{{ .ContainerID }}-feed">
        {{ range .Transcript }}
        {{ if .IsStep }}
        <div class="activity-status-line">
            <span class="status-dot dot-{{ .RoleClass }}"></span>
            <span class="activity-status-badge">{{ .SenderLabel }}</span>
            <span class="activity-status-text">{{ .Content }}</span>
            <span class="activity-status-time">{{ .Timestamp }}</span>
        </div>
        {{ else }}
        <div class="message {{ if .IsHuman }}message-human{{ else }}message-agent{{ end }}">
            <div class="message-bubble {{ if .IsHuman }}bubble-human{{ else }}bubble-agent{{ end }}">
                {{ if not .IsHuman }}
                <div class="message-sender">
                    <span class="sender-badge badge-{{ .RoleClass }}">{{ .SenderLabel }}</span>
                </div>
                {{ end }}
                <div class="message-content">{{ .ContentHTML }}</div>
                <div class="message-time">{{ .Timestamp }}</div>
            </div>
        </div>
        {{ end }}
        {{ end }}
        {{ if not .Transcript }}
        <div class="empty-chat">
            <div class="empty-chat-icon">&#9672;</div>
            <p>No activity yet.</p>
            <p class="empty-chat-hint">Start a conversation or launch agents to begin.</p>
        </div>
        {{ end }}
    </div>

    {{ if .PendingQuestion }}
    <div class="question-widget" id="question-widget">
        {{ if eq .PendingQuestion.Type "boolean" }}
        <div class="question-header">Agent is asking:</div>
        <p class="question-text">{{ .PendingQuestion.Question }}</p>
        <form hx-post="/web/specs/{{ .SpecID }}/answer"
              hx-target="#{{ .ContainerID }}"
              hx-swap="outerHTML">
            <input type="hidden" name="question_id" value="{{ .PendingQuestion.QuestionID }}">
            <div class="bool-buttons">
                <button type="submit" name="answer" value="Yes" class="btn btn-answer btn-yes">Yes</button>
                <button type="submit" name="answer" value="No" class="btn btn-answer btn-no">No</button>
            </div>
        </form>

        {{ else if eq .PendingQuestion.Type "multiple_choice" }}
        <div class="question-header">Agent is asking:</div>
        <p class="question-text">{{ .PendingQuestion.Question }}</p>
        <form hx-post="/web/specs/{{ .SpecID }}/answer"
              hx-target="#{{ .ContainerID }}"
              hx-swap="outerHTML">
            <input type="hidden" name="question_id" value="{{ .PendingQuestion.QuestionID }}">
            <div class="question-choices">
                {{ range .PendingQuestion.Choices }}
                <label class="choice-label">
                    {{ if $.PendingQuestion.AllowMulti }}
                    <input type="checkbox" name="answer" value="{{ . }}">
                    {{ else }}
                    <input type="radio" name="answer" value="{{ . }}">
                    {{ end }}
                    <span class="choice-text">{{ . }}</span>
                </label>
                {{ end }}
            </div>
            <button type="submit" class="btn btn-answer btn-submit">Submit</button>
        </form>

        {{ else if eq .PendingQuestion.Type "freeform" }}
        <div class="question-header">Agent is asking:</div>
        <p class="question-text">{{ .PendingQuestion.Question }}</p>
        <form hx-post="/web/specs/{{ .SpecID }}/answer"
              hx-target="#{{ .ContainerID }}"
              hx-swap="outerHTML">
            <input type="hidden" name="question_id" value="{{ .PendingQuestion.QuestionID }}">
            <div class="form-group">
                <textarea name="answer" placeholder="{{ .PendingQuestion.Placeholder }}" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-answer btn-submit">Submit</button>
        </form>
        {{ end }}
    </div>
    {{ end }}
</div>

<script>
    (function() {
        var feed = document.getElementById('{{ .ContainerID }}-feed');
        if (feed) feed.scrollTop = feed.scrollHeight;
    })();
</script>
{{ end }}
