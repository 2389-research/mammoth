{{define "content"}}
<link rel="stylesheet" href="/static/css/final.css">

<section class="final-shell">
    <section class="final-hero">
        <h1 class="final-title">Build Complete: {{.Project.Name}}</h1>
        <p class="final-sub">Run {{if .Project.RunID}}{{.Project.RunID}}{{else}}(unknown){{end}}. Review run order, node timings, and generated artifacts.</p>
        <div class="web-inline-actions" style="margin-top: 12px;">
            <a href="/projects/{{.Project.ID}}" class="btn">Project Overview</a>
            <a href="/projects/{{.Project.ID}}/build" class="btn">Back to Build Timeline</a>
        </div>
    </section>

    <section class="final-grid">
        <section class="final-card">
            <div class="final-card-head">
                <h2 class="final-card-title">Final Graph</h2>
                <span id="final-graph-status" class="web-note">Rendering…</span>
            </div>
            <div id="final-graph" class="final-graph">
                <div class="final-graph-empty">Rendering DOT diagram...</div>
            </div>
        </section>

        <section class="final-card">
            <div class="final-card-head">
                <h2 class="final-card-title">Steps</h2>
                <span id="timeline-count" class="web-note">Loading…</span>
            </div>
            <ul id="timeline-list" class="timeline-list">
                <li class="timeline-item"><span class="timeline-meta">Loading steps...</span></li>
            </ul>
        </section>

        <section class="final-card">
            <div class="final-card-head">
                <h2 class="final-card-title">Artifacts</h2>
                <span id="artifact-count" class="web-note">0 entries</span>
            </div>
            <div class="file-toolbar">
                <div class="file-path"><strong>Final Path:</strong> <span id="final-base-path">(loading...)</span></div>
                <div id="file-breadcrumbs" class="file-breadcrumbs"></div>
            </div>
            <div class="file-browser">
                <ul id="artifact-files" class="file-list">
                    <li class="web-note" style="padding: 8px 10px;">Loading artifacts...</li>
                </ul>
                <pre id="artifact-content" class="file-view">Select a file to view its content.</pre>
            </div>
        </section>
    </section>
</section>

<script src="/static/js/viz-render.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@viz-js/viz@3.11.0/lib/viz-standalone.js"></script>
<script>
(function() {
    var dotSource = {{ printf "%q" .Project.DOT }};
    var projectID = '{{.Project.ID}}';
    var graphEl = document.getElementById('final-graph');
    var graphStatus = document.getElementById('final-graph-status');
    var timelineList = document.getElementById('timeline-list');
    var timelineCount = document.getElementById('timeline-count');
    var activeGraphNode = '';

    var filesEl = document.getElementById('artifact-files');
    var contentEl = document.getElementById('artifact-content');
    var countEl = document.getElementById('artifact-count');
    var basePathEl = document.getElementById('final-base-path');
    var breadcrumbsEl = document.getElementById('file-breadcrumbs');
    var currentDir = '';

    function renderGraph() {
        var dotText = mammothViz.normalizeDOTSource(dotSource);
        if (!dotText || !dotText.trim()) {
            graphStatus.textContent = 'No DOT';
            graphEl.innerHTML = '<div class="final-graph-empty">No DOT available for this run.</div>';
            return;
        }
        if (typeof Viz === 'undefined') {
            graphStatus.textContent = 'Renderer unavailable';
            graphEl.innerHTML = '<div class="final-graph-empty">Could not load diagram renderer.</div>';
            return;
        }
        mammothViz.renderDOTToSVG(dotText).then(function(svg) {
            graphEl.innerHTML = svg;
            var svgEl = graphEl.querySelector('svg');
            if (svgEl) {
                svgEl.removeAttribute('width');
                svgEl.removeAttribute('height');
            }
            graphStatus.textContent = 'Ready';
            if (activeGraphNode) {
                mammothViz.setActiveNodeHighlight(activeGraphNode, graphEl, graphStatus);
            }
        }).catch(function(err) {
            graphStatus.textContent = 'Render failed';
            var msg = (err && err.message) ? String(err.message) : 'unknown error';
            graphEl.innerHTML = '<div class="final-graph-empty">Unable to render final graph: ' + mammothViz.escapeHTML(msg) + '</div>';
        });
    }

    function loadTimeline() {
        fetch('/projects/' + projectID + '/final/timeline', { headers: { 'Accept': 'application/json' } })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var steps = Array.isArray(data.steps) ? data.steps : [];
                var compactDates = shouldUseCompactDates(steps);
                timelineCount.textContent = steps.length + (steps.length === 1 ? ' node' : ' nodes');
                if (steps.length === 0) {
                    timelineList.innerHTML = '<li class="timeline-item"><span class="timeline-meta">No timeline data found for this run.</span></li>';
                    return;
                }
                timelineList.innerHTML = '';
                steps.forEach(function(step, idx) {
                    var item = document.createElement('li');
                    item.className = 'timeline-item';
                    item.setAttribute('role', 'button');
                    item.setAttribute('tabindex', '0');

                    var head = document.createElement('div');
                    head.className = 'timeline-head';
                    var node = document.createElement('span');
                    node.className = 'timeline-node';
                    node.textContent = (idx + 1) + '. ' + (step.node_id || 'unknown');
                    var status = document.createElement('span');
                    status.className = 'timeline-status';
                    status.textContent = step.status || 'unknown';
                    head.appendChild(node);
                    head.appendChild(status);

                    var meta = document.createElement('div');
                    meta.className = 'timeline-meta';

                    if (step.started_at || step.completed_at) {
                        var rangeChip = document.createElement('span');
                        rangeChip.className = 'timeline-chip';
                        var startText = step.started_at ? formatTimestamp(step.started_at, compactDates) : '?';
                        var endText = step.completed_at ? formatTimestamp(step.completed_at, compactDates) : '?';
                        if (step.started_at && step.completed_at && startText === endText) {
                            rangeChip.textContent = startText;
                        } else {
                            rangeChip.textContent = startText + ' → ' + endText;
                        }
                        meta.appendChild(rangeChip);
                    }
                    if (step.duration_ms) {
                        var durChip = document.createElement('span');
                        durChip.className = 'timeline-chip';
                        durChip.textContent = formatDurationHMS(step.duration_ms);
                        meta.appendChild(durChip);
                    }

                    item.appendChild(head);
                    item.appendChild(meta);
                    if (step.error) {
                        var err = document.createElement('div');
                        err.className = 'timeline-error';
                        err.textContent = formatTimelineError(step.error);
                        item.appendChild(err);
                    }
                    var opsWrap = document.createElement('div');
                    opsWrap.className = 'timeline-ops';
                    var ops = Array.isArray(step.operations) ? step.operations : [];
                    if (ops.length === 0) {
                        var empty = document.createElement('div');
                        empty.className = 'timeline-op';
                        empty.textContent = 'No operation events captured for this step.';
                        opsWrap.appendChild(empty);
                    } else {
                        ops.forEach(function(op) {
                            var opEl = document.createElement('div');
                            opEl.className = 'timeline-op';
                            var top = document.createElement('div');
                            top.className = 'timeline-op-top';
                            var typ = document.createElement('span');
                            typ.className = 'timeline-op-type';
                            typ.textContent = String(op.type || 'event');
                            var tm = document.createElement('span');
                            tm.className = 'timeline-op-time';
                            tm.textContent = op.timestamp ? formatTimestamp(op.timestamp, compactDates) : '';
                            top.appendChild(typ);
                            top.appendChild(tm);
                            opEl.appendChild(top);
                            var summary = document.createElement('div');
                            summary.className = 'timeline-op-summary';
                            summary.textContent = String(op.summary || op.type || 'event');
                            opEl.appendChild(summary);
                            opsWrap.appendChild(opEl);
                        });
                    }
                    item.appendChild(opsWrap);
                    item.addEventListener('click', function() {
                        item.classList.toggle('open');
                        if (step.node_id) {
                            mammothViz.setActiveNodeHighlight(step.node_id, graphEl, graphStatus);
                        }
                    });
                    item.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            item.classList.toggle('open');
                            if (step.node_id) {
                                mammothViz.setActiveNodeHighlight(step.node_id, graphEl, graphStatus);
                            }
                        }
                    });
                    timelineList.appendChild(item);
                });
            })
            .catch(function() {
                timelineCount.textContent = 'Error';
                timelineList.innerHTML = '<li class="timeline-item"><span class="timeline-meta">Failed to load run timeline.</span></li>';
            });
    }

    function formatDurationHMS(durationMS) {
        var totalSeconds = Math.max(0, Math.floor(Number(durationMS || 0) / 1000));
        var hours = Math.floor(totalSeconds / 3600);
        var minutes = Math.floor((totalSeconds % 3600) / 60);
        var seconds = totalSeconds % 60;
        var mm = String(minutes).padStart(2, '0');
        var ss = String(seconds).padStart(2, '0');
        if (hours > 0) {
            return String(hours) + ':' + mm + ':' + ss;
        }
        return mm + ':' + ss;
    }

    function formatTimestamp(ts, compactDates) {
        var d = new Date(String(ts || ''));
        if (Number.isNaN(d.getTime())) {
            return String(ts || '');
        }
        if (compactDates) {
            return d.toLocaleTimeString(undefined, {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
        }
        return d.toLocaleString(undefined, {
            year: 'numeric',
            month: 'short',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true,
            timeZoneName: 'short'
        });
    }

    function shouldUseCompactDates(steps) {
        var dayKey = '';
        for (var i = 0; i < steps.length; i++) {
            var t = steps[i].started_at || steps[i].completed_at;
            if (!t) {
                continue;
            }
            var d = new Date(String(t));
            if (Number.isNaN(d.getTime())) {
                continue;
            }
            var key = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
            if (!dayKey) {
                dayKey = key;
            } else if (dayKey !== key) {
                return false;
            }
        }
        return dayKey !== '';
    }

    function formatTimelineError(msg) {
        var s = String(msg || '');
        if (s.indexOf('No interviewer available for human gate:') === 0) {
            var gate = s.split(':').slice(1).join(':').trim();
            if (gate) {
                return 'Human review gate "' + gate + '" is enabled, but no reviewer is connected.';
            }
            return 'Human review gate is enabled, but no reviewer is connected.';
        }
        return s;
    }

    function renderBreadcrumbs(dir) {
        breadcrumbsEl.innerHTML = '';
        var root = document.createElement('button');
        root.type = 'button';
        root.className = 'crumb';
        root.textContent = '/';
        root.addEventListener('click', function() { loadArtifactList(''); });
        breadcrumbsEl.appendChild(root);

        if (!dir) {
            return;
        }
        var parts = dir.split('/').filter(Boolean);
        var accum = '';
        parts.forEach(function(part) {
            accum = accum ? (accum + '/' + part) : part;
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'crumb';
            btn.textContent = part;
            (function(targetDir) {
                btn.addEventListener('click', function() { loadArtifactList(targetDir); });
            })(accum);
            breadcrumbsEl.appendChild(btn);
        });
    }

    function loadArtifactList(dir) {
        currentDir = dir || '';
        var url = '/projects/' + projectID + '/artifacts/list?dir=' + encodeURIComponent(currentDir);
        fetch(url, { headers: { 'Accept': 'application/json' } })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var entries = Array.isArray(data.entries) ? data.entries : [];
                countEl.textContent = entries.length + (entries.length === 1 ? ' entry' : ' entries');
                basePathEl.textContent = String(data.base_path || '');
                renderBreadcrumbs(String(data.dir || ''));

                if (entries.length === 0) {
                    filesEl.innerHTML = '<li class="web-note" style="padding: 8px 10px;">No entries in this directory.</li>';
                    return;
                }

                filesEl.innerHTML = '';
                entries.forEach(function(entry) {
                    var li = document.createElement('li');
                    var btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'file-btn';
                    var prefix = entry.is_dir ? '[DIR] ' : '[FILE] ';
                    btn.textContent = prefix + entry.name;
                    btn.addEventListener('click', function() {
                        filesEl.querySelectorAll('.file-btn').forEach(function(b) { b.classList.remove('active'); });
                        btn.classList.add('active');
                        if (entry.is_dir) {
                            loadArtifactList(entry.path);
                            return;
                        }
                        loadArtifactFile(entry.path);
                    });
                    li.appendChild(btn);
                    filesEl.appendChild(li);
                });
            })
            .catch(function() {
                filesEl.innerHTML = '<li class="web-note" style="padding: 8px 10px; color: #b91c1c;">Failed to load artifact directory.</li>';
            });
    }

    function loadArtifactFile(filePath) {
        contentEl.textContent = 'Loading ' + filePath + '...';
        var url = '/projects/' + projectID + '/artifacts/file?path=' + encodeURIComponent(filePath);
        fetch(url, { headers: { 'Accept': 'application/json' } })
            .then(function(r) {
                if (!r.ok) {
                    throw new Error('failed');
                }
                return r.json();
            })
            .then(function(data) {
                contentEl.textContent = String(data.content || '');
            })
            .catch(function() {
                contentEl.textContent = 'Unable to load artifact content.';
            });
    }

    renderGraph();
    loadTimeline();
    loadArtifactList('');
})();
</script>
{{end}}
